#!/bin/zsh
set -euo pipefail

git rev-parse --is-inside-work-tree >/dev/null 2>&1 || { echo "❌ Nicht in einem Git-Repo"; exit 1; }
cd "$(git rev-parse --show-toplevel)"

origin_url="$(git remote get-url origin 2>/dev/null || echo "")"

push_kreisrund() {
  git add -A
  git commit -m "update(kreisrund): $(date -u +%Y-%m-%dT%H:%M:%SZ)" || true
  git push
  echo "✅ Kreisrund: push ok"
}

sync_ghp() {
  git remote get-url kreis >/dev/null 2>&1 || git remote add kreis git@github.com:Jeremia1964/yechida-kreisrund.github.io.git
  git fetch kreis
  if [ -d kreisrund ]; then
    git subtree pull --prefix=kreisrund kreis main --squash
  else
    git subtree add  --prefix=kreisrund kreis main --squash
  fi
  git config pull.rebase false
  git pull origin main --allow-unrelated-histories || true
  git push --set-upstream origin main || true
  echo "✅ GHP: sync + push ok"
}

if [[ "$origin_url" == *"yechida-kreisrund.github.io"* ]]; then
  push_kreisrund
else
  sync_ghp
fi
